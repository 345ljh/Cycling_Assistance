#include "inputmethod.h"

/* 输入法实现 */
// 各拼音对应字数与偏移量, 最大为yi 364
uint16_t character_offset[] = {0, 8, 102, 174, 186, 265, 424, 427, 434, 435, 498, 498, 498, 498, 498, 498, 498, 498, 498, 498, 498, 502, 502, 546, 546, 546, 546, 546, 546, 546, 546, 546, 546, 546, 623, 661, 721, 768, 846, 846, 932, 966, 1010, 1010, 1225, 1225, 1301, 1301, 1364, 1393, 1443, 1508, 1508, 1508, 1668, 1668, 1668, 1733, 1733, 1733, 1733, 1733, 1733, 1733, 1733, 1733, 1733, 1744, 1771, 1824, 1851, 1883, 1915, 1915, 1926, 1940, 1940, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2022, 2091, 2105, 2152, 2152, 2152, 2179, 2179, 2179, 2238, 2257, 2307, 2307, 2374, 2399, 2528, 2606, 2657, 2697, 2697, 2789, 2917, 2917, 3109, 3109, 3109, 3109, 3109, 3109, 3109, 3109, 3109, 3109, 3109, 3161, 3241, 3354, 3357, 3367, 3406, 3441, 3441, 3465, 3517, 3565, 3565, 3630, 3699, 3827, 3886, 3959, 3976, 3978, 3980, 4010, 4010, 4171, 4172, 4246, 4246, 4320, 4396, 4396, 4446, 4446, 4451, 4451, 4519, 4571, 4662, 4662, 4662, 4690, 4690, 4690, 4738, 4786, 4885, 4885, 4926, 4926, 5017, 5061, 5061, 5061, 5154, 5249, 5341, 5341, 5341, 5341, 5341, 5341, 5342, 5342, 5342, 5342, 5342, 5342, 5347, 5347, 5362, 5629, 5629, 5629, 5629, 5629, 5629, 5629, 5629, 5629, 5629, 5650, 5698, 5779, 5824, 5880, 5992, 5994, 6004, 6046, 6046, 6046, 6046, 6046, 6046, 6046, 6046, 6046, 6046, 6046, 6046, 6046, 6109, 6170, 6290, 6336, 6349, 6427, 6466, 6466, 6595, 6624, 6696, 6696, 6706, 6739, 6864, 6894, 6966, 7099, 7104, 7115, 7141, 7141, 7141, 7141, 7141, 7141, 7141, 7141, 7141, 7141, 7141, 7141, 7141, 7238, 7277, 7446, 7527, 7551, 7660, 7740, 7740, 7923, 7977, 8061, 8061, 8061, 8061, 8061, 8061, 8061, 8061, 8061, 8061, 8061, 8061, 8436, 8548, 8812, 8884, 9051, 9240, 9354, 9482, 9523, 9598, 9598, 9598, 9598, 9815, 9815, 9815, 9892, 9892, 10031, 10031, 10103, 10103, 10103, 10116, 10166, 10212, 10248, 10274, 10367, 10370, 10391, 10417, 10417, 10417, 10417, 10417, 10417, 10417, 10417, 10417, 10417, 10417, 10417, 10417, 10436, 10473, 10518, 10539, 10576, 10592, 10658, 10658, 10750, 10808, 10839, 10839, 10884, 10941, 11037, 11086, 11152, 11177, 11258, 11259, 11273, 11273, 11549, 11551, 11664, 11716, 11792, 11852, 11936, 12036, 12036, 12134, 12136, 12211, 12259, 12429, 12429, 12429, 12466, 12466, 12480, 12480, 12515, 12615, 12700, 12755, 12784, 12839, 12883, 12960, 12969, 13062, 13094, 13165, 13165, 13272, 13272, 13330, 13330, 13365, 13390, 13456, 13490, 13490, 13495, 13615, 13615, 13645, 13709, 13709, 13709, 13709, 13709, 13709, 13709, 13709, 13709, 13709, 13753, 13784, 13818, 13840, 13886, 13896, 13912, 13919, 13924, 13924, 14017, 14017, 14059, 14065, 14081, 14157, 14162, 14201, 14201, 14221, 14221, 14250, 14263, 14284, 14284, 14284, 14294, 14294, 14299, 14299, 14301, 14341, 14354, 14382, 14405, 14478, 14524, 14571, 14571, 14629, 14643, 14725, 14725, 14878, 14878, 14920, 14920, 14961, 14973, 15005, 15065, 15065, 15065, 15128, 15128, 15152, 15229, 15229, 15229, 15229, 15229, 15229, 15229, 15229, 15229, 15229, 15229, 15229, 15229, 15229, 15229, 15229, 15229, 15229, 15229, 15229, 15508, 15541, 15740, 15818, 15942, 16002, 16102, 16177, 16214, 16319, 16319, 16319, 16319, 16456, 16456, 16456, 16548, 16548, 16595, 16595, 16613, 16613, 16613, 16613, 16613, 16638, 16664, 16684, 16694, 16694, 16759, 16769, 16769, 16776, 16776, 16776, 16776, 16776, 16776, 16776, 16776, 16776, 16776, 16776, 16831, 16859, 16921, 16922, 16922, 16945, 16945, 16945, 16980, 16989, 17012, 17012, 17046, 17063, 17097, 17110, 17144, 17192, 17192, 17200, 17202, 17202, 17323, 17323, 17323, 17323, 17323, 17323, 17323, 17323, 17323, 17323, 17323, 17374, 17421, 17502, 17502, 17502, 17514, 17514, 17514, 17594, 17623, 17682, 17682, 17743, 17758, 17882, 17924, 17973, 18035, 18037, 18154, 18222, 18222, 18457, 18457, 18457, 18457, 18457, 18457, 18457, 18457, 18457, 18457, 18457, 18457, 18488, 18630, 18637, 18647, 18657, 18684, 18684, 18703, 18721, 18757, 18757, 18828, 18885, 18988, 19075, 19140, 19155, 19156, 19156, 19181, 19181, 19303, 19303, 19387, 19387, 19451, 19477, 19477, 19538, 19538, 19538, 19538, 19618, 19646, 19724, 19724, 19724, 19762, 19762, 19762, 19805, 19849, 19961, 19961, 20010, 20020, 20122, 20171, 20171, 20171, 20404, 20494, 20516, 20516, 20516, 20516, 20516, 20516, 20516, 20516, 20516, 20516, 20516, 20516, 20580, 20580, 20580, 20765, 20765, 20765, 20765, 20765, 20765, 20765, 20765, 20765, 20765, 20765, 20765, 20765, 20765, 20765, 20765, 20765, 20765, 20765, 20765, 21072, 21172, 21421, 21521, 21682, 21855, 21914, 21983, 22012, 22072, 22072, 22072, 22072, 22232, 22232, 22232, 22352, 22352, 22411, 22411, 22530, 22530, 22530, 22634, 22634, 22922, 23024, 23174, 23291, 23291, 23291, 23291, 23291, 23750, 23750, 23750, 23750, 23750, 23750, 23914, 24078, 24078, 24078, 24083, 24162, 24298, 24648, 24648, 24648, 24781, 24781, 24861, 24861, 24980, 24980, 24980, 25016, 25041, 25095, 25120, 25162, 25226, 25234, 25241, 25265, 25265, 25385, 25385, 25385, 25385, 25385, 25385, 25385, 25385, 25385, 25385, 25385, 25458, 25490, 25545, 25545, 25545, 25566, 25566, 25566, 25612, 25641, 25687, 25687, 25783, 25824, 25924, 25976, 26036, 26121, 26123, 26251, 26334, 26334, 26637, 26637, 26637, 26637, 26637, 26637, 26637, 26637, 26637, 26637, 26637, 26712, 26812, 26984, 26993, 27000, 27055, 27087, 27087, 27133, 27160, 27259};
uint16_t character_len[] = {8, 94, 72, 12, 79, 159, 3, 7, 1, 63, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 0, 44, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 77, 38, 60, 47, 78, 0, 86, 34, 44, 0, 215, 0, 76, 0, 63, 29, 50, 65, 0, 0, 160, 0, 0, 65, 0, 0, 0, 0, 0, 0, 0, 0, 0, 11, 27, 53, 27, 32, 32, 0, 11, 14, 0, 82, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 69, 14, 47, 0, 0, 27, 0, 0, 59, 19, 50, 0, 67, 25, 129, 78, 51, 40, 0, 92, 128, 0, 192, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 52, 80, 113, 3, 10, 39, 35, 0, 24, 52, 48, 0, 65, 69, 128, 59, 73, 17, 2, 2, 30, 0, 161, 1, 74, 0, 74, 76, 0, 50, 0, 5, 0, 68, 52, 91, 0, 0, 28, 0, 0, 48, 48, 99, 0, 41, 0, 91, 44, 0, 0, 93, 95, 92, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 5, 0, 15, 267, 0, 0, 0, 0, 0, 0, 0, 0, 0, 21, 48, 81, 45, 56, 112, 2, 10, 42, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 63, 61, 120, 46, 13, 78, 39, 0, 129, 29, 72, 0, 10, 33, 125, 30, 72, 133, 5, 11, 26, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 97, 39, 169, 81, 24, 109, 80, 0, 183, 54, 84, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 375, 112, 264, 72, 167, 189, 114, 128, 41, 75, 0, 0, 0, 217, 0, 0, 77, 0, 139, 0, 72, 0, 0, 13, 50, 46, 36, 26, 93, 3, 21, 26, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 19, 37, 45, 21, 37, 16, 66, 0, 92, 58, 31, 0, 45, 57, 96, 49, 66, 25, 81, 1, 14, 0, 276, 2, 113, 52, 76, 60, 84, 100, 0, 98, 2, 75, 48, 170, 0, 0, 37, 0, 14, 0, 35, 100, 85, 55, 29, 55, 44, 77, 9, 93, 32, 71, 0, 107, 0, 58, 0, 35, 25, 66, 34, 0, 5, 120, 0, 30, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 44, 31, 34, 22, 46, 10, 16, 7, 5, 0, 93, 0, 42, 6, 16, 76, 5, 39, 0, 20, 0, 29, 13, 21, 0, 0, 10, 0, 5, 0, 2, 40, 13, 28, 23, 73, 46, 47, 0, 58, 14, 82, 0, 153, 0, 42, 0, 41, 12, 32, 60, 0, 0, 63, 0, 24, 77, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 279, 33, 199, 78, 124, 60, 100, 75, 37, 105, 0, 0, 0, 137, 0, 0, 92, 0, 47, 0, 18, 0, 0, 0, 0, 25, 26, 20, 10, 0, 65, 10, 0, 7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 55, 28, 62, 1, 0, 23, 0, 0, 35, 9, 23, 0, 34, 17, 34, 13, 34, 48, 0, 8, 2, 0, 121, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 51, 47, 81, 0, 0, 12, 0, 0, 80, 29, 59, 0, 61, 15, 124, 42, 49, 62, 2, 117, 68, 0, 235, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 31, 142, 7, 10, 10, 27, 0, 19, 18, 36, 0, 71, 57, 103, 87, 65, 15, 1, 0, 25, 0, 122, 0, 84, 0, 64, 26, 0, 61, 0, 0, 0, 80, 28, 78, 0, 0, 38, 0, 0, 43, 44, 112, 0, 49, 10, 102, 49, 0, 0, 233, 90, 22, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 64, 0, 0, 185, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 307, 100, 249, 100, 161, 173, 59, 69, 29, 60, 0, 0, 0, 160, 0, 0, 120, 0, 59, 0, 119, 0, 0, 104, 0, 288, 102, 150, 117, 0, 0, 0, 0, 459, 0, 0, 0, 0, 0, 164, 164, 0, 0, 5, 79, 136, 350, 0, 0, 133, 0, 80, 0, 119, 0, 0, 36, 25, 54, 25, 42, 64, 8, 7, 24, 0, 120, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 73, 32, 55, 0, 0, 21, 0, 0, 46, 29, 46, 0, 96, 41, 100, 52, 60, 85, 2, 128, 83, 0, 303, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 75, 100, 172, 9, 7, 55, 32, 0, 46, 27, 99, 0};

InputMethod* InputMethod_Init(void){
    InputMethod* obj = (InputMethod*)malloc(sizeof(InputMethod));
    memset(obj, 0, sizeof(InputMethod));
    return obj;
}

void InputMethod_Add(InputMethod* obj, uint16_t code){
    switch(obj->operation){
    case 0:
        if(code < INITIAL_AMOUNT){
            obj->buffer[obj->now_buffer_index].chs[obj->buffer[obj->now_buffer_index].len].initial = (uint8_t)code;
            obj->operation = 1;
        } else if(code == 0xFF){
            obj->buffer[obj->now_buffer_index].chs[obj->buffer[obj->now_buffer_index].len].initial = 0xFF;
            obj->buffer[obj->now_buffer_index].chs[obj->buffer[obj->now_buffer_index].len].final = 0xFF;
            obj->operation = 3;
        }
        break;
    case 1:
        if(code < FINAL_AMOUNT && character_len[obj->buffer[obj->now_buffer_index].chs[obj->buffer[obj->now_buffer_index].len].initial * FINAL_AMOUNT + (uint8_t)code]){
            obj->buffer[obj->now_buffer_index].chs[obj->buffer[obj->now_buffer_index].len].final = (uint8_t)code;
            obj->operation = 2;
        } 
        break;
    case 2:
        if(code < character_len[obj->buffer[obj->now_buffer_index].chs[obj->buffer[obj->now_buffer_index].len].initial * FINAL_AMOUNT + obj->buffer[obj->now_buffer_index].chs[obj->buffer[obj->now_buffer_index].len].final]){
            obj->buffer[obj->now_buffer_index].chs[obj->buffer[obj->now_buffer_index].len].index = code;
            obj->buffer[obj->now_buffer_index].len++;
            obj->operation = 0;
        }
        break;
    case 3:
        if(code < ASCII_AMOUNT){  // code 0~94 -> ascii 32~126
            obj->buffer[obj->now_buffer_index].chs[obj->buffer[obj->now_buffer_index].len].index = code;
            obj->buffer[obj->now_buffer_index].len++;
            obj->operation = 0;
        }
    }
}

void InputMethod_Delete(InputMethod* obj){
    switch(obj->operation){
    case 0:
        if(obj->buffer[obj->now_buffer_index].len > 0){
            obj->buffer[obj->now_buffer_index].len--;
        }
        break;
    case 1:
        obj->operation--;
        break;
    case 2:
        obj->operation--;
        break;
    case 3:
        obj->operation = 0;
    }
}

void InputMethod_Switch(InputMethod* obj){
    obj->now_buffer_index++;
    obj->now_buffer_index %= INPUTMETHOD_DATA_AMOUNT;
    obj->operation = 0;
}

